<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Sensor Recording Demo</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.2/css/bulma.min.css">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.11.0/NoSleep.min.js"></script> 
</head>

<body>
  <section class="section">
    <div class="content">
      <div id="plot" style="width:100%; height:250px;"></div>
      <p>(Tap once to keep screen on while recording)</p>
      <h4>LinearAccelerationSensor</h4>
      <ul>
        <li>Timestamp: <span id="LinearAccelerationTime">OFF</span></li>
        <li>X-axis: <span id="LinearAccelerationX">OFF</span> m/s²</li>
        <li>Y-axis: <span id="LinearAccelerationY">OFF</span> m/s²</li>
        <li>Z-axis: <span id="LinearAccelerationZ">OFF</span> m/s²</li>
      </ul>
      <h4>Gyroscope</h4>
      <ul>
        <li>Timestamp: <span id="GyroscopeTime">OFF</span></li>
        <li>X-axis: <span id="GyroscopeX">OFF</span> rad/s</li>
        <li>Y-axis: <span id="GyroscopeY">OFF</span> rad/s</li>
        <li>Z-axis: <span id="GyroscopeZ">OFF</span> rad/s</li>
      </ul>
      <h4>AbsoluteOrientationSensor</h4>
      <ul>
        <li>Timestamp: <span id="OrientationTime">OFF</span></li>
        <li>X-axis: <span id="OrientationX">OFF</span>°</li>
        <li>Y-axis: <span id="OrientationY">OFF</span>°</li>
        <li>Z-axis: <span id="OrientationZ">OFF</span>°</li>
      </ul>
    </div>
  </section>

  <script type="module">
    /* noSleep is for preventing screen lock while walking
      Need to bind the listener to a record button */
    var noSleep = new NoSleep()
    document.addEventListener('click', function enableNoSleep() {
      document.removeEventListener('click', enableNoSleep, false)
      noSleep.enable()
    }, false)

    // Initialize empty plot
    const plotdiv = document.getElementById('plot')
    const data = [{  // data is an array of traces
      x: [],
      y: [],
      name: 'X',
      type: 'line'
    },
    { 
      x: [],
      y: [],
      name: 'Y',
      type: 'line'
    },
    { 
      x: [],
      y: [],
      name: 'Z',
      type: 'line'
    }]
    const layout = {
      margin: { l: 20, r: 20, t: 30, b: 30 },
      title: "LinearAcceleration",
      displayModeBar: false,
    }
    Plotly.newPlot(plotdiv, data, layout)

    // Create sensors
    function updateSensorMeasurement(time, val, id) {
      document.getElementById(`${id}Time`).innerHTML = time
      document.getElementById(`${id}X`).innerHTML = val[0]
      document.getElementById(`${id}Y`).innerHTML = val[1]
      document.getElementById(`${id}Z`).innerHTML = val[2]
    }

    const sampling_frequency = 60  // 100 samples a second (10 ms intervals)
    const sensor_absorient = new AbsoluteOrientationSensor({ frequency: sampling_frequency })
    const sensor_linacc = new LinearAccelerationSensor({ frequency: sampling_frequency })
    const sensor_gyro = new Gyroscope({ frequency: sampling_frequency })
    
    function setupSensor(sensor, label, plotdiv) {
      const isQuaternion = 'quaternion' in sensor
      sensor.onreading = () => {
        let output = isQuaternion ? sensor.quaternion : [sensor.x, sensor.y, sensor.z] 
        updateSensorMeasurement(sensor.timestamp, output, label)
        if (plotdiv) {
          Plotly.extendTraces(plotdiv, 
            {x: [[sensor.timestamp], [sensor.timestamp], [sensor.timestamp]], 
             y: [[output[0]], [output[1]], [output[2]]]}, [0,1,2], 60*10)
        }
      }
      sensor.onerror = event => {
        if (event.error.name == 'NotReadableError') {
          console.log(`Sensor (${label}) is not available.`)
        }
      }
      sensor.start()
    }

    setupSensor(sensor_absorient, "Orientation")
    setupSensor(sensor_gyro, "Gyroscope")
    setupSensor(sensor_linacc, "LinearAcceleration", plotdiv)

  </script>
</body>

</html>